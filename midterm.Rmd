---
title: "Midterm"
author: "Sining Leng"
date: "2025-03-24"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(ggplot2)
library(dplyr)
library(caret)
library(car)
library(readr)
library(tidyr)
library(knitr)
library(patchwork)
library(glmnet)
library(earth)
library(tidyverse)
library(corrplot)
library(mgcv)
library(nlme)
library(vip)
```

Load data
```{r, message=FALSE}
load("dat1.RData")
load("dat2.RData")

dat1 =
  dat1 |>
  select(-id)

dat2 =
  dat2 |>
  select(-id)
```


# Explorey Data Analysis and Visualization 

## Summary statistics

```{r}
summarize_cat = function(data, var_name) {
  
  var_label = deparse(substitute(var_name))
  
  out_df = 
    data |> 
    count({{ var_name }}) |> 
    mutate(
      Percent = round(100 * n / sum(n), 1),
      Variable = var_label,
      Level = as.character({{ var_name }})
    ) |> 
    rename(N = n) |> 
    select(Variable, Level, N, Percent)
  
  return(out_df)
}

gender <- summarize_cat(dat1, gender)
race <- summarize_cat(dat1, race)
smoking <- summarize_cat(dat1, smoking)
diabetes <- summarize_cat(dat1, diabetes)
hypertension <- summarize_cat(dat1, hypertension)
bind_rows(gender, race, smoking, diabetes, hypertension) %>%
  knitr::kable()

summarize_cont = function(data, var_name) {
  
  var_label = deparse(substitute(var_name))
  
  out_df = 
    data |> 
    summarize(
      Variable = var_label,
      Median = round(median({{ var_name }}, na.rm = TRUE), 1),
      Q1 = round(quantile({{ var_name }}, 0.25, na.rm = TRUE), 1),
      Q3 = round(quantile({{ var_name }}, 0.75, na.rm = TRUE), 1)
    ) |> 
    mutate(
      IQR = paste0("[", Q1, ", ", Q3, "]")
    ) |> 
    select(Variable, Median, IQR)
  
  return(out_df)
}

age = summarize_cont(dat1, age)
bmi = summarize_cont(dat1, bmi)
height = summarize_cont(dat1, height)
weight = summarize_cont(dat1, weight)
SBP = summarize_cont(dat1, SBP)
LDL = summarize_cont(dat1, LDL)
log_anti = summarize_cont(dat1, log_antibody)
bind_rows(age, bmi, height, weight, SBP, LDL, log_anti) %>%
  knitr::kable()
```


## Distribution of antibody levels

```{r}
ggplot(dat1, aes(x = log_antibody)) +
  geom_histogram(binwidth = 0.2, fill = 'skyblue', color = 'black') +
  labs(title = "Distribution of Log-Transformed Antibody Levels")

ggplot(dat2, aes(x = log_antibody)) +
  geom_histogram(binwidth = 0.2, fill = 'skyblue', color = 'black') +
  labs(title = "Distribution of Log-Transformed Antibody Levels")
```


## Scatterplots of Continuous Predictors vs. Log-Antibody

```{r}
dat1 %>%
  select(age, height, weight, bmi, SBP, LDL, time, log_antibody) %>%
  pivot_longer(
    cols = c(age,  height, weight, bmi, SBP, LDL, time),
    names_to = "predictor",
    values_to = "value"
  ) %>%
  ggplot(aes(x = value, y = log_antibody)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "loess", se = FALSE, color = "blue") +
  facet_wrap(~ predictor, scales = "free_x") +
  labs(
    x = "Predictor Value",
    y = "Log-Antibody",
    title = "Scatterplots of Continuous Predictors vs. Log-Antibody"
  )
```


## Correlation Matrix of Continuous Variables

```{r}
dat1 %>%
  select(age, height, weight, bmi, SBP, LDL, time, log_antibody) %>%
  cor(use = "complete.obs") %>% 
  corrplot(type = "full",
           title = "Correlation Matrix of Continuous Variables",
           addCoef.col = "black",
           mar = c(0,0,2,0))
```


## Boxplots of log_antibody by categorical variables

```{r}
dat1 %>%
  select(log_antibody, gender, race, smoking, diabetes, hypertension) %>%
  mutate(
    gender = factor(dat1$gender, 
                      levels = c(0, 1), 
                      labels = c("Female", "Male")),
    race = factor(dat1$race, 
                    levels = c(1, 2, 3, 4), 
                    labels = c("White", "Asian", "Black", "Hispanic")),
    smoking = factor(dat1$smoking, 
                       levels = c(0, 1, 2), 
                       labels = c("Never", "Former", "Current")),
    diabetes = factor(dat1$diabetes, 
                        levels = c(0, 1), 
                        labels = c("No", "Yes")),
    hypertension = factor(dat1$hypertension, 
                            levels = c(0, 1), 
                            labels = c("No", "Yes"))
  ) %>%
  pivot_longer(
    cols = c(gender, race, smoking, diabetes, hypertension),
    names_to = "predictor",
    values_to = "category"
  ) %>% 
  ggplot(aes(x = category, y = log_antibody)) +
  geom_boxplot() +
  facet_wrap(~ predictor, scales = "free_x") +
  labs(
    x = "Category",
    y = "Log-Antibody",
    title = "Boxplots of Log-Antibody by Categorical Predictors"
  )
```

# Antibody level and time
```{r}
p1 <- ggplot(dat1, aes(x = time, y = log_antibody)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "loess", color = "blue") +
  labs(title = "Antibody Level vs Time Since Vaccination (dat1)")

p2 <- ggplot(dat2, aes(x = time, y = log_antibody)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "loess", color = "blue") +
  labs(title = "Antibody Level vs Time Since Vaccination (dat2)")

p1+p2
```


# Models Building

cross-validation

```{r}
set.seed(123)
ctrl = trainControl(method = "cv", number = 10)
```

## LASSO

```{r}
set.seed(123)
model_lasso <- train(
  log_antibody ~ .,
  data = dat1,
  method = "glmnet",
  trControl = ctrl,
  tuneGrid = expand.grid(alpha = 1,
                         lambda = exp(seq(2, -30, length = 100))

))

plot(model_lasso, xTrans = log)
model_lasso$bestTune

```



## GAM

```{r}
set.seed(123)
model_gam <- train(
  log_antibody ~ .,
  data = dat1,
  method = "gam",
  trControl = ctrl
)

model_gam$finalModel
model_gam$bestTune

par(mfrow = c(2,2))
plot(model_gam$finalModel)
```



## MARS

```{r}
set.seed(123)
model_mars <- train(
  log_antibody ~ .,
  data = dat1,
  method = "earth",
  trControl = ctrl,
  tuneLength = 5
)

plot(model_mars)
coef(model_mars$finalModel)
vip(model_mars$finalModel, type = "nsubsets")
vip(model_mars$finalModel, type = "rss")
```


# Predictions and Model Evaluation

```{r}
set.seed(123)

pred_lasso <- predict(model_lasso, newdata = dat2)
pred_mars  <- predict(model_mars, newdata = dat2)
pred_gam   <- predict(model_gam, newdata = dat2)

resample = resamples(list(lasso = model_lasso, gam = model_gam, mars = model_mars))
summary(resample)
```

MARS model has the lowest RMSE (0.5276)

