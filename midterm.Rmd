---
title: "Midterm"
author: "Sining Leng"
date: "2025-03-24"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(ggplot2)
library(dplyr)
library(caret)
library(car)
library(readr)
library(tidyr)
library(knitr)
library(patchwork)
library(glmnet)
library(earth)
```

Load data
```{r, message=FALSE}
load("dat1.RData")
load("dat2.RData")

dat1 =
  dat1 |>
  select(-id)

dat2 =
  dat2 |>
  select(-id)
```

# EXPLORATORY DATA ANALYSIS

## Summary statistics
```{r}
summarize_cat = function(data, var_name) {
  
  var_label = deparse(substitute(var_name))
  
  out_df = 
    data |> 
    count({{ var_name }}) |> 
    mutate(
      Percent = round(100 * n / sum(n), 1),
      Variable = var_label,
      Level = as.character({{ var_name }})
    ) |> 
    rename(N = n) |> 
    select(Variable, Level, N, Percent)
  
  return(out_df)
}

gender <- summarize_cat(dat1, gender)
race <- summarize_cat(dat1, race)
smoking <- summarize_cat(dat1, smoking)
diabetes <- summarize_cat(dat1, diabetes)
hypertension <- summarize_cat(dat1, hypertension)
bind_rows(gender, race, smoking, diabetes, hypertension) %>%
  knitr::kable()

summarize_cont = function(data, var_name) {
  
  var_label = deparse(substitute(var_name))
  
  out_df = 
    data |> 
    summarize(
      Variable = var_label,
      Median = round(median({{ var_name }}, na.rm = TRUE), 1),
      Q1 = round(quantile({{ var_name }}, 0.25, na.rm = TRUE), 1),
      Q3 = round(quantile({{ var_name }}, 0.75, na.rm = TRUE), 1)
    ) |> 
    mutate(
      IQR = paste0("[", Q1, ", ", Q3, "]")
    ) |> 
    select(Variable, Median, IQR)
  
  return(out_df)
}

age = summarize_cont(dat1, age)
bmi = summarize_cont(dat1, bmi)
height = summarize_cont(dat1, height)
weight = summarize_cont(dat1, weight)
SBP = summarize_cont(dat1, SBP)
LDL = summarize_cont(dat1, LDL)
log_anti = summarize_cont(dat1, log_antibody)
bind_rows(age, bmi, height, weight, SBP, LDL, log_anti) %>%
  knitr::kable()
```

# Distribution of antibody levels
```{r}
ggplot(dat1, aes(x = log_antibody)) +
  geom_histogram(binwidth = 0.2, fill = 'skyblue', color = 'black') +
  labs(title = "Distribution of Log-Transformed Antibody Levels")

ggplot(dat2, aes(x = log_antibody)) +
  geom_histogram(binwidth = 0.2, fill = 'skyblue', color = 'black') +
  labs(title = "Distribution of Log-Transformed Antibody Levels")
```

# Antibody level vs time since vaccination
```{r}
p1 = ggplot(dat1, aes(x = time, y = log_antibody)) +
geom_point(alpha = 0.5) +
geom_smooth(method = "loess", color = "blue") +
labs(title = "Dataset 1: Antibody Level vs Time")

p2 = ggplot(dat2, aes(x = time, y = log_antibody)) +
geom_point(alpha = 0.5) +
geom_smooth(method = "loess", color = "blue") +
labs(title = "Dataset 2: Antibody Level vs Time")
p1 + p2
```

```{r}
ggplot(dat1, aes(x = factor(gender), y = log_antibody)) +
  geom_boxplot() +
  scale_x_discrete(labels = c("Female", "Male")) +
  labs(title = "Antibody Level by Gender")
```

# Lasso
```{r}
x1 <- model.matrix(log_antibody ~ age + gender + race + smoking + bmi +
                   diabetes + hypertension + SBP + LDL + time, data = dat1)[, -1]
y1 <- dat1$log_antibody

x2 <- model.matrix(log_antibody ~ age + gender + race + smoking + bmi +
                   diabetes + hypertension + SBP + LDL + time, data = dat2)[, -1]
y2 <- dat2$log_antibody
```

```{r}
set.seed(123)
cv.lasso = cv.glmnet(x1, y1, alpha = 1,
                     lambda = exp(seq(5, -30, length = 100)))

plot(cv.lasso)
cv.lasso$lambda.1se

predict(cv.lasso, s = "lambda.1se", type = "coefficients")

pred_glmnet <- predict(cv.lasso, newx = dat2, s = "lambda.1se")
sqrt(mean((pred_glmnet - y2)^2))

# Plot predicted vs actual
plot(y2, pred_glmnet,
     xlab = "Observed Log Antibody Level",
     ylab = "Predicted",
     main = "Observed vs Predicted (Lasso - dat2)")
abline(0, 1, col = "red")
```

# GAM
```{r}
set.seed(123)

ctrl = trainControl(method = "cv", number = 10)

gam.fit <- train(x1, y1, method = "gam", trControl = ctrl)
gam.fit$bestTune
gam.fit$finalModel

gam_model <- gam(log_antibody ~ gender + race + smoking + 
    diabetes + hypertension + s(age) + s(SBP) + s(LDL) + s(bmi) + 
    s(time), data = dat1)

par(mfrow = c(2, 2))
plot(gam_model)

pred_gam <- predict(gam_model, newdata = dat2)
sqrt(mean((pred_gam - y2)^2))
```

# Antibody level and time
```{r}
library(splines)
model_spline <- lm(log_antibody ~ ns(time, df = 4), data = dat1)
summary(model_spline)
```

